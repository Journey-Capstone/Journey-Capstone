<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head th:fragment="head (title)">
	<meta charset="UTF-8">
	<title th:text="${title}"></title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
	<link rel="stylesheet" th:href="@{/css/main.css}">
</head>
<body>


	<nav th:fragment="navbar"  class="navbar container-fluid bg-light">
		<div class="container d-flex justify-content-center">
		<div class="col-6" >
			<a class="navbar-brand" href="#">
				<img src="./images/book_logo.png" alt="" width="30" height="24">
			</a>
		</div>
		<div class="d-flex justify-content-end col-6 align-items-center">
			<a href="#">About</a>
			<a href="#" class="m-2"><button class="btn btn-outline-primary">Login</button></a>
			<a href="#" class="m-2"><button class="btn btn-primary">Register</button></a>
		</div>
		</div>
	</nav>

	<nav th:fragment="navlogin">
		<article>
			<section id="search" class="results">
				<div class="flex">
					<input
							id="search-box"
							class="search-box"
							placeholder="Search Title or Author"
							aria-label="Search books"
					/>
				</div>
			</section>
		</article>
	</nav>





<!-- BOOTSTRAP JS -->
<script th:fragment="bootstrap-js" src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>

<script th:fragment="jquery" src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>

<script th:fragment="search-js">
	let bookContainer = document.querySelector(".search");
	let searchBooks = document.getElementById("search-box");
	const getBooks = async (book) => {
		const response = await fetch(
			`https://www.googleapis.com/books/v1/volumes?q=${book}`
		);
		const data = await response.json();
		return data;
	};

	const getThumbnail = ({ imageLinks }) => {
		const thumbImage = "icons/logo.svg";
		if (!imageLinks || !imageLinks.thumbnail) {
			return thumbImage;
		}
		return imageLinks.thumbnail.replace("http://", "https://");
	};
	//subject == Genre on Google Books
	const showBooks = async (subject, startIndex = 0) => {
		let bookContainer = document.querySelector(`.${subject}`);
		bookContainer.innerHTML = `<div class='prompt'><div class="loader"></div></div>`;
		const data = await getBooks(
			`subject:${subject}&startIndex=${startIndex}&maxResults=6`
		);
		if (data.error) {
			bookContainer.innerHTML = `<div class='prompt'>ツ Limit exceeded! Try after some time</div>`;
		} else if (data.totalItems == 0) {
			bookContainer.innerHTML = `<div class='prompt'>ツ No results, try a different term!</div>`;
		} else if (data.totalItems == undefined) {
			bookContainer.innerHTML = `<div class='prompt'>ツ Network problem!</div>`;
		} else if (!data.items || data.items.length == 0) {
			bookContainer.innerHTML = `<div class='prompt'>ツ There is no more result!</div>`;
		} else {
			bookContainer.innerHTML = data.items;
			bookContainer.innerHTML = data.items
				.map(
					({ volumeInfo }) =>
						`<div class='book' style='background: linear-gradient(` +
						getRandomColor() +
						`, rgba(0, 0, 0, 0));'><a href='${volumeInfo.previewLink}' target='_blank'><img class='thumbnail' src='` +
						getThumbnail(volumeInfo) +
						`' alt='cover'></a><div class='book-info'><h3 class='book-title'><a href='${volumeInfo.previewLink}' target='_blank'>${volumeInfo.title}</a></h3><div class='book-authors' onclick='updateFilter(this,"author");'>${volumeInfo.authors}</div><div class='info' onclick='updateFilter(this,"subject");' style='background-color: ` +
						getRandomColor() +
						`;'>` +
						(volumeInfo.categories === undefined
							? "Others"
							: volumeInfo.categories) +
						`</div></div></div>`
				)
				.join("");
		}
	};
	const ListBook = async () => {
		if (searchBooks.value != "") {
			bookContainer.style.display = "flex";
			bookContainer.innerHTML = `<div class='prompt'><div class="loader"></div></div>`;
			const data = await getBooks(`${searchBooks.value}&maxResults=6`);
			if (data.error) {
				bookContainer.innerHTML = `<div class='prompt'>ツ Limit exceeded! Try after some time</div>`;
			} else if (data.totalItems == 0) {
				bookContainer.innerHTML = `<div class='prompt'>ツ No results, try a different term!</div>`;
			} else if (data.totalItems == undefined) {
				bookContainer.innerHTML = `<div class='prompt'>ツ Network problem!</div>`;
			} else {
				//book data and style to show on page

				bookContainer.innerHTML = data.items.map(({ volumeInfo }) =>
							`<div class='book' style='background-color: lightblue'>
							<a href='${volumeInfo.previewLink}' target='_blank'>
							<img class='thumbnail' src='` + getThumbnail(volumeInfo) + `' alt='cover'></a>


							<div class='book-info'>
							<h3 class='book-title'>
							<!--allows user to go to the preview link on google books api-->
							<a href='${volumeInfo.previewLink}' target='_blank'>${volumeInfo.title}</a>
							</h3>

							<div class='book-authors' onclick='updateFilter(this,"author");'>${volumeInfo.authors}</div>

							<div class='info' onclick='updateFilter(this,"subject");' style='background-color: white'>` +(volumeInfo.categories === undefined ? "Others" : volumeInfo.categories) +
							`</div>
</div>
</div>`).join("");}
		} else {
			bookContainer.style.display = "none";
		}
	};

	const debounce = (fn, time, to = 0) => {
		to ? clearTimeout(to) : (to = setTimeout(ListBook, time));
	};
	searchBooks.addEventListener("input", () => debounce(ListBook, 1000));
	//https://developer.mozilla.org/en-US/docs/Web/API/Window/DOMContentLoaded_event -- Try out diff events for loading DOM
	document.addEventListener("DOMContentLoaded", () => {
		showBooks("sci-fi");
		showBooks("feminism");
		showBooks("inspirational");
		showBooks("horror");
		showBooks("fiction");
		showBooks("poetry");
		showBooks("fantasy");
		showBooks("romance");
	});

	const prev = (subject) => {
		startIndex -= 6;
		if (startIndex <= 0) {
			startIndex = 0;
			showBooks(subject, startIndex);
			document.getElementById(`${subject}-prev`).style.display = "none";
		} else {
			document.getElementById(`${subject}-prev`).style.display = "inline-flex";
			showBooks(subject, startIndex);
		}
	};
</script>

</body>
</html>